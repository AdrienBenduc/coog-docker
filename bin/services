#!/bin/bash
#----------
# Create COMPOSE_FILE variable to integrate needed services declared in services.env file
#----------
export BASE_PATH=`realpath "$(dirname $0)/.."`
. "${BASE_PATH}/bin/helpers/colors.sh"
. "${BASE_PATH}/services.env"

PREFIX="$1"
FILES="docker-compose.yml"
for service in ${SERVICES[@]}
do
    service_file="compose/${service}.yml"
    if [ -f "$service_file" ]
    then
        check "${service} ajout√©" "" "${PREFIX}"
        FILES="${FILES}:${service_file}"
    else
        fail "${service} n'existe pas" "" "${PREFIX}"
    fi
done

if [[ ! $(cat "${BASE_PATH}/.env" | grep "COMPOSE_FILE") ]]; then
    fail '"COMPOSE_FILE" not found in ' "${BASE_PATH}/.env, aborting..."
    exit 1
fi

sed -i -E "s|^(COMPOSE_FILE=).*?$|\1$FILES|" "${BASE_PATH}/.env"
