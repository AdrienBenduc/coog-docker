#!/bin/bash
#----------
# Allow to deploy a stack to a docker swarm
#----------
BASE_PATH=`realpath "$(dirname $0)/.."`
. "${BASE_PATH}/bin/helpers/colors.sh"

# Check env and services
${BASE_PATH}/bin/init "  "

section "DÃ©ploiement"
# Export .env files to be accessible to deploy command
. "${BASE_PATH}/.env"
export $(cut -d= -f1 "${BASE_PATH}/.env")

# Get stacks file to use from COMPOSE_FILE variable from builded .env file
STACK_FILES="-c ${BASE_PATH}/$(echo ${COMPOSE_FILE} | sed -E "s|:| -c ${BASE_PATH}/|g")"

# Deploy
docker stack deploy ${STACK_FILES} "$COMPOSE_PROJECT_NAME"
