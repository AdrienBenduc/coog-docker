version: '3'

services:
  reverse-proxy:
    image: traefik:v2.1
    ports:
      - 80:80
      - 8080:8080
    volumes:
      - ./traefik.toml:/etc/traefik/traefik.toml
      - /var/run/docker.sock:/var/run/docker.sock:ro
  coog:
    image: coopengo/coog:coog-2.7.17
    command: ["server", "1"]
    depends_on:
      - redis
      - postgres
    env_file:
      - var.env
    labels:
      -  "traefik.http.routers.coogz.rule=Host(`coog.localhost`)"

  postgres:
    image: postgres:11.7-alpine
    env_file:
    - postgres.env
    volumes:
      - ./init-user-db.sh:/docker-entrypoint-initdb.d/init-user-db.sh

  redis:
    image: redis:5.0.7-alpine
    environment:
      - ALLOW_EMPTY_PASSWORD=yes

  mongo:
    image: mongo
    env_file:
    - var.env
    volumes:
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
     # - ./mongo-volume:/data/db
 
  gateway:
    image: coopengo/gateway:coog-2.6.13
    env_file:
    - var.env
    depends_on:
      - mongo
      - reverse-proxy
    labels:
      - "traefik.http.routers.gateway.rule=Host(`coog.localhost`) && PathPrefix(`/gateway`)"

  api:
    image: coopengo/api:coog-2.6.13
    env_file:
      - var.env
    depends_on:
      - mongo

  api-b2b-config:
    image: coopengo/api-b2b-config:coog-2.6.13
    env_file:
      - var.env
    depends_on:
      - mongo

  api-referential:
    image: coopengo/api-referential:coog-2.6.13
    env_file:
      - var.env
    depends_on:
      - mongo

  api-identity-manager:
    image: coopengo/api-identity-manager:coog-2.6.13
    env_file:
      - var.env
    depends_on:
      - mongo
      - api

  web:
    image: coopengo/web:coog-2.6.13
    env_file:
      - web.env
    command: ["server", "1"]
    depends_on:
      - redis
    labels:
      - "traefik.http.routers.web.rule=Host(`web.localhost`)"

  portal:
    image: coopengo/portal-prevere:prevere-coog-2.6.13
    command: ["server", "1"]
    env_file:
      - var.env
    labels:
      - "traefik.http.routers.portal.rule=Host(`coog.localhost`) && PathPrefix(`/portal`)"
      - "traefik.http.middlewares.test-redirectregex.redirectregex.regex=/portal(/|$$)(.*)"
      - "traefik.http.middlewares.test-redirectregex.redirectregex.replacement=/portal/$${2}"

  static:
    image: coopengo/static:coog-2.6.13
    labels:
      - "traefik.http.routers.static.rule=Host(`coog.localhost`) && ( PathPrefix(`/sao`) || PathPrefix(`/doc`) || PathPrefix(`/bench`) )"

  busybox:
    image: busybox
    command: tail -f /dev/null

  centos:
    image: centos
    command: tail -f /dev/null

